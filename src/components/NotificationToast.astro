---
import { getCollection } from 'astro:content';

// Get all announcements
const allAnnouncements = await getCollection('announcements', ({ data }) => {
  const isPublished = import.meta.env.PROD ? data.draft !== true : true;
  
  // Filter out announcements older than 1 week, unless they are pinned
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const isRecent = data.date >= oneWeekAgo;
  
  return isPublished && (data.pinned || isRecent);
});

// Sort by pinned status (pinned first) and then by date (newest first)
const sortedAnnouncements = allAnnouncements.sort((a, b) => {
  if (a.data.pinned && !b.data.pinned) return -1;
  if (!a.data.pinned && b.data.pinned) return 1;
  return b.data.date.valueOf() - a.data.date.valueOf();
});

const latestAnnouncement = sortedAnnouncements.length > 0 ? sortedAnnouncements[0] : null;

// Only render if there is an announcement
if (!latestAnnouncement) {
  return null;
}
---

{latestAnnouncement && (
  <div id="notification-toast" data-slug={latestAnnouncement.slug} class="fixed bottom-4 right-4 z-50 max-w-sm w-full bg-white border-l-4 border-burgundy shadow-lg rounded-r-lg transform transition-all duration-500 translate-y-20 opacity-0 hidden" role="alert">
    <div class="p-4 relative">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-burgundy/10 text-burgundy">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
            </svg>
          </span>
        </div>
        <div class="ml-3 w-0 flex-1 pt-0.5">
          <p class="text-sm font-medium text-gray-900">
            Recent Announcement
          </p>
          <p class="mt-1 text-sm text-gray-500 line-clamp-2">
            {latestAnnouncement.data.title}
          </p>
          <div class="mt-2 flex">
            <a href={`/announcements/${latestAnnouncement.slug}`} class="text-sm font-medium text-burgundy hover:text-burgundy/80 focus:outline-none focus:underline transition ease-in-out duration-150">
              Read more &rarr;
            </a>
          </div>
        </div>
        <div class="ml-4 flex-shrink-0 flex">
          <button id="dismiss-toast" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-burgundy">
            <span class="sr-only">Close</span>
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const toast = document.getElementById('notification-toast');
    const dismissBtn = document.getElementById('dismiss-toast');
    const readMoreLink = toast?.querySelector('a');
    
    if (toast && dismissBtn) {
      const slug = toast.dataset.slug;
      const storageKey = `seen_announcement_${slug}`;
      const clickedKey = `clicked_announcement_${slug}`;
      
      const lastSeen = localStorage.getItem(storageKey);
      const hasClicked = localStorage.getItem(clickedKey);
      const currentTime = new Date().getTime();
      const RESHOW_DELAY = 3 * 60 * 60 * 1000; // 3 hours in milliseconds

      // Show if:
      // 1. Never clicked AND
      // 2. Either never seen OR seen more than 6 hours ago
      const shouldShow = !hasClicked && (!lastSeen || (currentTime - parseInt(lastSeen) > RESHOW_DELAY));

      if (shouldShow) {
        // Remove hidden class first to allow display, but keep it transparent/translated for animation
        toast.classList.remove('hidden');
        
        // Show toast after a small delay
        setTimeout(() => {
          toast.classList.remove('translate-y-20', 'opacity-0');
        }, 1000);

        // Update last seen timestamp
        localStorage.setItem(storageKey, currentTime.toString());

        const markAsClicked = () => {
          localStorage.setItem(clickedKey, 'true');
        };

        const hideToast = () => {
          toast.classList.add('translate-y-20', 'opacity-0');
          // Remove from DOM after transition
          setTimeout(() => {
            toast.classList.add('hidden');
          }, 500);
        };

        // Auto dismiss after 20 seconds (without marking as clicked)
        const autoDismissTimer = setTimeout(hideToast, 20000);

        // Manual dismiss (just hides for now, will reshow after delay)
        dismissBtn.addEventListener('click', () => {
          clearTimeout(autoDismissTimer);
          hideToast();
        });

        // Mark as clicked if user interacts with the link
        readMoreLink?.addEventListener('click', () => {
          markAsClicked();
        });
      }
    }
  </script>
)}